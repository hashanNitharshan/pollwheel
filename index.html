<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Poll Wheel</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f8fafc;display:flex;justify-content:center;padding:18px}
    .card{width:min(640px,100%);background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:#6b7280;font-size:14px;margin:0}
    label{display:block;margin-top:12px;font-weight:700}
    input{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;font-size:16px;margin-top:8px}
    button{padding:12px 16px;border:0;border-radius:10px;cursor:pointer;font-size:16px}
    .btn{background:#111827;color:#fff}
    .btn2{background:#e5e7eb}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .error{color:#dc2626;font-weight:700;margin-top:10px;display:none}
    .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:14px}
    .arrow{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:22px solid #e11d48;margin-bottom:-6px}
    canvas{border-radius:50%;border:6px solid #222;background:#fff}
    #result{font-size:18px;font-weight:900}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
    .badge{background:#111827;color:#fff;padding:6px 10px;border-radius:999px;font-size:14px;font-weight:800}
  </style>
</head>
<body>

  <div id="loginView" class="card" style="display:none;">
    <h1>Team Login</h1>
    <p class="muted">TS, TPS, TD, TLK, TG, TT</p>
    <label for="teamInput">Team Code</label>
    <input id="teamInput" placeholder="TS / TPS / TD / TLK / TG / TT" autocomplete="off" />
    <div class="row">
      <button id="loginBtn" class="btn">Login</button>
    </div>
    <div id="loginError" class="error"></div>
  </div>

  <div id="wheelView" class="card" style="display:none;">
    <div class="topbar">
      <div><h1 style="margin:0;">Poll Wheel</h1></div>
      <div class="row" style="margin:0;">
        <span id="teamBadge" class="badge">TEAM: —</span>
        <button id="logoutBtn" class="btn2" type="button">Logout</button>
      </div>
    </div>

    <div class="wrap">
      <div class="arrow"></div>
      <canvas id="wheel" width="420" height="420"></canvas>
      <button id="spinBtn" class="btn">SPIN (ONE TIME)</button>
      <div id="result">Result: —</div>
      <div id="status" class="muted"></div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // ✅ Your Firebase config (tpl-poll-wheel)
    const firebaseConfig = {
      apiKey: "AIzaSyApEQ8ogTpZ94IZRh_GWtCsUhi608x4sG4",
      authDomain: "tpl-poll-wheel.firebaseapp.com",
      projectId: "tpl-poll-wheel",
      storageBucket: "tpl-poll-wheel.firebasestorage.app",
      messagingSenderId: "149256036270",
      appId: "1:149256036270:web:f7d9486571ef69501df23f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const TEAM_TO_PLAYER={
      TS:"Selva",
      TPS:"Navinkanth",
      TD:"Divagar",
      TLK:"Ilayaraja",
      TG:"Janaster",
      TT:"Father of Rakshan"
    };

    const options=["Selva","Navinkanth","Divagar","Ilayaraja","Janaster","Father of Rakshan"];
    const sliceColors=["#facc15","#ec4899","#92400e","#ef4444","#8b5cf6","#0ea5e9"];

    const KEY_CURRENT_TEAM="pollwheel_current_team";

    const loginView=document.getElementById("loginView");
    const wheelView=document.getElementById("wheelView");
    const teamInput=document.getElementById("teamInput");
    const loginBtn=document.getElementById("loginBtn");
    const loginError=document.getElementById("loginError");
    const teamBadge=document.getElementById("teamBadge");
    const logoutBtn=document.getElementById("logoutBtn");

    const canvas=document.getElementById("wheel");
    const ctx=canvas.getContext("2d");
    const spinBtn=document.getElementById("spinBtn");
    const resultEl=document.getElementById("result");
    const statusEl=document.getElementById("status");

    const cx=canvas.width/2, cy=canvas.height/2;
    const radius=Math.min(cx,cy)-10;
    const TAU=Math.PI*2;

    let angle=0, spinning=false;
    let unsubTeam=null;

    const normalizeTeam=(s)=>(s||"").trim().toUpperCase();
    const isValidTeam=(t)=>Object.prototype.hasOwnProperty.call(TEAM_TO_PLAYER,t);

    function teamRef(team){ return db.collection("teams").doc(team); }

    function showLogin(){
      if(unsubTeam){ unsubTeam(); unsubTeam=null; }
      wheelView.style.display="none";
      loginView.style.display="block";
      loginError.style.display="none";
      teamInput.value="";
      teamInput.focus();
    }

    function showWheel(team){
      loginView.style.display="none";
      wheelView.style.display="block";
      teamBadge.textContent="TEAM: "+team;
      drawWheel();
      listenTeam(team);
    }

    async function ensureTeamDoc(team){
      const ref=teamRef(team);
      const snap=await ref.get();
      if(!snap.exists){
        await ref.set({
          team,
          loginUsed:false,
          spun:false,
          winner:"",
          mode:"fixed",
          fixedPick: TEAM_TO_PLAYER[team] || "",
          randomPick:"",
          updatedAt: Date.now()
        }, { merge:true });
      }
    }

    function listenTeam(team){
      if(unsubTeam){ unsubTeam(); unsubTeam=null; }
      unsubTeam = teamRef(team).onSnapshot((doc)=>{
        const data = doc.exists ? doc.data() : null;
        applyState(team, data);
      });
    }

    async function doLogin(){
      const team=normalizeTeam(teamInput.value);
      if(!isValidTeam(team)){
        loginError.textContent="Invalid team";
        loginError.style.display="block";
        return;
      }

      await ensureTeamDoc(team);

      const ref = teamRef(team);

      try{
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ref);
          const d = snap.data() || {};
          if(d.loginUsed === true){
            throw new Error("LOCKED");
          }
          tx.set(ref, { loginUsed:true, updatedAt:Date.now() }, { merge:true });
        });

        localStorage.setItem(KEY_CURRENT_TEAM, team);
        showWheel(team);

      }catch(e){
        loginError.textContent="One team one time logged";
        loginError.style.display="block";
      }
    }

    loginBtn.addEventListener("click",doLogin);
    teamInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

    logoutBtn.addEventListener("click",()=>{
      localStorage.removeItem(KEY_CURRENT_TEAM);
      resultEl.textContent="Result: —";
      statusEl.textContent="";
      showLogin();
    });

    function drawWheel(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const slice=TAU/options.length;
      for(let i=0;i<options.length;i++){
        const start=angle+i*slice, end=start+slice;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,start,end);
        ctx.closePath();
        ctx.fillStyle=sliceColors[i]||"#3b82f6";
        ctx.fill();

        ctx.save();
        ctx.translate(cx,cy);
        ctx.rotate(start+slice/2);
        ctx.textAlign="right";
        ctx.fillStyle="#fff";
        ctx.font="bold 16px Arial";
        ctx.fillText(options[i],radius-14,6);
        ctx.restore();
      }
      ctx.beginPath();
      ctx.arc(cx,cy,42,0,TAU);
      ctx.fillStyle="#111827";
      ctx.fill();
      ctx.fillStyle="#fff";
      ctx.font="bold 14px Arial";
      ctx.textAlign="center";
      ctx.fillText("SPIN",cx,cy+5);
    }

    function angleForIndexAtTop(idx){
      const slice=TAU/options.length;
      const pointerAngle=idx*slice+slice/2;
      let a=(Math.PI*1.5-pointerAngle)%TAU;
      if(a<0)a+=TAU;
      return a;
    }

    function spinToIndex(idx,onDone){
      if(spinning)return;
      spinning=true;

      const startAngle=angle;
      const finalAngleBase=angleForIndexAtTop(idx);
      const extraSpins=6+Math.floor(Math.random()*3);
      const targetAngle=finalAngleBase+extraSpins*TAU;
      const start=performance.now();
      const duration=5200;
      const easeOutCubic=(t)=>1-Math.pow(1-t,3);

      function frame(now){
        const t=Math.min(1,(now-start)/duration);
        const eased=easeOutCubic(t);
        angle=startAngle+(targetAngle-startAngle)*eased;
        drawWheel();
        if(t<1)requestAnimationFrame(frame);
        else{
          angle=finalAngleBase;
          drawWheel();
          spinning=false;
          onDone&&onDone();
        }
      }
      requestAnimationFrame(frame);
    }

    function applyState(team, d){
      if(!d) return;

      if(d.spun && d.winner){
        spinBtn.disabled=true;
        resultEl.textContent="Result: "+d.winner+" ✅";
        statusEl.textContent="Congratulations";
        const idx=options.indexOf(d.winner);
        if(idx>=0){ angle=angleForIndexAtTop(idx); drawWheel(); }
      }else{
        spinBtn.disabled=false;
        resultEl.textContent="Result: —";
        statusEl.textContent="";
      }
    }

    async function spinOnce(){
      const team = localStorage.getItem(KEY_CURRENT_TEAM);
      if(!team || !isValidTeam(team)) return;

      await ensureTeamDoc(team);

      const ref = teamRef(team);

      try{
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ref);
          const d = snap.data() || {};

          if(d.spun === true){
            throw new Error("ALREADY");
          }

          const mode = d.mode || "fixed";
          let winner = "";

          if(mode === "random"){
            winner = d.randomPick || "";
            if(!winner || !options.includes(winner)){
              throw new Error("NO_RANDOM_ASSIGNED");
            }
          }else{
            const fp = d.fixedPick;
            if(fp && options.includes(fp)) winner = fp;
            else winner = TEAM_TO_PLAYER[team] || "";
          }

          if(!winner || !options.includes(winner)){
            throw new Error("BAD_WINNER");
          }

          tx.set(ref, { spun:true, winner, updatedAt:Date.now() }, { merge:true });
          tx.set(db.collection("events").add({}), {}); // no-op (ignored)
        });

        const snap = await ref.get();
        const d = snap.data();
        const winner = d.winner;

        const idx = options.indexOf(winner);
        if(idx < 0) return;

        spinBtn.disabled=true;
        resultEl.textContent="Result: spinning...";
        statusEl.textContent="Spinning...";

        spinToIndex(idx, ()=>{
          resultEl.textContent="Result: "+winner+" ✅";
          statusEl.textContent="Congratulations";
        });

      }catch(e){
        if(String(e.message).includes("NO_RANDOM_ASSIGNED")){
          statusEl.textContent="Admin not assigned random winner yet";
        }
      }
    }

    spinBtn.addEventListener("click",spinOnce);
    canvas.addEventListener("click",spinOnce);

    (async function boot(){
      const savedTeam = localStorage.getItem(KEY_CURRENT_TEAM);
      if(savedTeam && isValidTeam(savedTeam)){
        await ensureTeamDoc(savedTeam);
        showWheel(savedTeam);
      }else{
        showLogin();
      }
    })();
  </script>
</body>
</html>
