<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Control - Poll Wheel</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f8fafc;padding:18px}
    .card{max-width:1100px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    h1{margin:0 0 8px;font-size:20px}
    .muted{color:#6b7280;font-size:14px;margin:0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-size:14px}
    .btn{background:#111827;color:#fff}
    .btn2{background:#e5e7eb}
    .danger{background:#dc2626;color:#fff}
    .ok{background:#16a34a;color:#fff}
    .hr{height:1px;background:#e5e7eb;margin:14px 0}
    input,select{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#f8fafc;font-weight:800}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
    .pill.gray{background:#e5e7eb}
    .pill.green{background:#dcfce7;color:#166534}
    .pill.red{background:#fee2e2;color:#991b1b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;color:#6b7280;margin-top:4px}
  </style>
</head>
<body>

  <div class="card" id="lockCard" style="display:none;">
    <h1>Admin Login</h1>
    <div class="row">
      <input id="pinInput" type="password" placeholder="Admin PIN" />
      <button class="btn" id="pinBtn">Unlock</button>
    </div>
    <p id="pinErr" class="muted" style="color:#dc2626;font-weight:800;display:none;margin-top:10px;">Wrong PIN</p>
  </div>

  <div class="card" id="adminCard" style="display:none;">
    <h1>Admin Control Panel</h1>

    <div class="row">
      <button class="btn" id="refreshBtn">Refresh</button>
      <button class="ok" id="assignRandomBtn">Assign RANDOM Winners (No Duplicates)</button>
      <button class="btn2" id="forceLogoutBtn">Force Logout</button>
      <button class="danger" id="resetAllBtn">RESET ALL</button>
    </div>

    <div class="hr"></div>

    <table>
      <thead>
        <tr>
          <th style="width:80px;">Team</th>
          <th style="width:320px;">Admin Mode</th>
          <th>Team Status</th>
          <th style="width:360px;">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script>
    const ADMIN_PIN="1234";

    const TEAMS=["TS","TPS","TD","TLK","TG"];
    const options=["Selva","Navinkanth","Divagar","Ilayaraja","Janaster"];

    const KEY_CURRENT_TEAM="pollwheel_current_team";

    const keyLoginUsed=(t)=>`pollwheel_login_used_${t}`;
    const keySpun=(t)=>`pollwheel_spun_${t}`;
    const keyWinner=(t)=>`pollwheel_winner_${t}`;

    const keyMode=(t)=>`pollwheel_admin_mode_${t}`;                  // fixed|random
    const keyFixedPick=(t)=>`pollwheel_admin_fixed_pick_${t}`;
    const keyAdminRandomPick=(t)=>`pollwheel_admin_random_pick_${t}`; // pre-assigned unique random

    const DEFAULT_MODE="fixed";
    const ADMIN_UNLOCK_KEY="pollwheel_admin_unlocked";

    const lockCard=document.getElementById("lockCard");
    const adminCard=document.getElementById("adminCard");
    const pinInput=document.getElementById("pinInput");
    const pinBtn=document.getElementById("pinBtn");
    const pinErr=document.getElementById("pinErr");

    const tbody=document.getElementById("tbody");
    const refreshBtn=document.getElementById("refreshBtn");
    const forceLogoutBtn=document.getElementById("forceLogoutBtn");
    const resetAllBtn=document.getElementById("resetAllBtn");
    const assignRandomBtn=document.getElementById("assignRandomBtn");

    const pill=(txt,kind)=>`<span class="pill ${kind}">${txt}</span>`;

    const getMode=(t)=>localStorage.getItem(keyMode(t))||DEFAULT_MODE;

    function getFixedPick(t){
      const pick=localStorage.getItem(keyFixedPick(t));
      return (pick&&options.includes(pick))?pick:options[0];
    }

    function getRandomPick(t){
      const pick=localStorage.getItem(keyAdminRandomPick(t));
      return (pick&&options.includes(pick))?pick:"—";
    }

    function render(){
      tbody.innerHTML="";
      TEAMS.forEach(team=>{
        const loginUsed=localStorage.getItem(keyLoginUsed(team))==="1";
        const spun=localStorage.getItem(keySpun(team))==="1";
        const winner=localStorage.getItem(keyWinner(team))||"—";
        const mode=getMode(team);
        const fixedPick=getFixedPick(team);
        const randomPick=getRandomPick(team);

        const statusHtml=`
          <div>${loginUsed?pill("LOGIN USED","red"):pill("LOGIN FREE","green")}</div>
          <div style="margin-top:6px;">
            ${spun?pill("SPUN","green"):pill("NOT SPUN","gray")}
            <div class="small">Winner: <b>${winner}</b></div>
          </div>
        `;

        const modeHtml=`
          <div class="row" style="margin:0;">
            <select data-act="setMode" data-team="${team}">
              <option value="fixed" ${mode==="fixed"?"selected":""}>FIXED</option>
              <option value="random" ${mode==="random"?"selected":""}>RANDOM</option>
            </select>

            <select data-act="setFixed" data-team="${team}" ${mode==="random"?"disabled":""}>
              ${options.map(o=>`<option value="${o}" ${o===fixedPick?"selected":""}>${o}</option>`).join("")}
            </select>
          </div>
          <div class="small">Random Pick: <b>${randomPick}</b></div>
        `;

        const actionsHtml=`
          <div class="actions">
            <button class="btn2" data-act="unlockLogin" data-team="${team}">Unlock Login</button>
            <button class="btn2" data-act="resetSpin" data-team="${team}">Reset Spin</button>
            <button class="btn2" data-act="clearRandomPick" data-team="${team}">Clear Random</button>
            <button class="danger" data-act="wipeTeam" data-team="${team}">Wipe Team</button>
          </div>
        `;

        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><b>${team}</b></td>
          <td>${modeHtml}</td>
          <td>${statusHtml}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function unlockLogin(team){
      localStorage.removeItem(keyLoginUsed(team));
      if(localStorage.getItem(KEY_CURRENT_TEAM)===team) localStorage.removeItem(KEY_CURRENT_TEAM);
    }
    function resetSpin(team){
      localStorage.removeItem(keySpun(team));
      localStorage.removeItem(keyWinner(team));
    }
    function clearRandomPick(team){
      localStorage.removeItem(keyAdminRandomPick(team));
    }
    function wipeTeam(team){
      localStorage.removeItem(keyLoginUsed(team));
      localStorage.removeItem(keySpun(team));
      localStorage.removeItem(keyWinner(team));
      localStorage.removeItem(keyMode(team));
      localStorage.removeItem(keyFixedPick(team));
      localStorage.removeItem(keyAdminRandomPick(team));
      if(localStorage.getItem(KEY_CURRENT_TEAM)===team) localStorage.removeItem(KEY_CURRENT_TEAM);
    }
    function resetAll(){
      if(!confirm("RESET ALL?")) return;
      TEAMS.forEach(wipeTeam);
      localStorage.removeItem(KEY_CURRENT_TEAM);
      render();
    }

    function shuffle(arr){
      const a=arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // ✅ Assign UNIQUE random winners (no duplicates)
    function assignRandomUnique(){
      const randomTeams=TEAMS.filter(t=>getMode(t)==="random");
      const used=new Set();

      // keep already assigned random picks (avoid changing them unless conflict)
      randomTeams.forEach(t=>{
        const pick=localStorage.getItem(keyAdminRandomPick(t));
        if(pick&&options.includes(pick)) used.add(pick);
      });

      const remaining=options.filter(o=>!used.has(o));
      const pool=shuffle(remaining);

      randomTeams.forEach(t=>{
        let pick=localStorage.getItem(keyAdminRandomPick(t));
        if(pick && options.includes(pick)) return;
        if(pool.length===0){
          // not enough unique names, clear all random picks and re-assign
          randomTeams.forEach(x=>localStorage.removeItem(keyAdminRandomPick(x)));
          return assignRandomUnique();
        }
        localStorage.setItem(keyAdminRandomPick(t), pool.pop());
      });

      render();
      alert("Assigned unique RANDOM winners.");
    }

    document.addEventListener("change",(e)=>{
      const el=e.target;
      const act=el?.dataset?.act;
      const team=el?.dataset?.team;
      if(!act||!team) return;

      if(act==="setMode"){
        const newMode=el.value==="random"?"random":"fixed";
        localStorage.setItem(keyMode(team),newMode);
        if(newMode==="fixed") localStorage.removeItem(keyAdminRandomPick(team));
        if(newMode==="fixed" && !options.includes(localStorage.getItem(keyFixedPick(team)))) {
          localStorage.setItem(keyFixedPick(team), options[0]);
        }
        render();
      }

      if(act==="setFixed"){
        const pick=el.value;
        if(options.includes(pick)) localStorage.setItem(keyFixedPick(team),pick);
        render();
      }
    });

    document.addEventListener("click",(e)=>{
      const btn=e.target.closest("button");
      if(!btn) return;

      const act=btn.dataset.act;
      const team=btn.dataset.team;

      if(act==="unlockLogin"){unlockLogin(team);render();}
      if(act==="resetSpin"){resetSpin(team);render();}
      if(act==="clearRandomPick"){clearRandomPick(team);render();}
      if(act==="wipeTeam"){if(confirm(`Wipe ${team}?`)){wipeTeam(team);render();}}
    });

    refreshBtn.addEventListener("click",render);
    forceLogoutBtn.addEventListener("click",()=>{localStorage.removeItem(KEY_CURRENT_TEAM);alert("Forced logout");});
    resetAllBtn.addEventListener("click",resetAll);
    assignRandomBtn.addEventListener("click",assignRandomUnique);

    function showLock(){lockCard.style.display="block";adminCard.style.display="none";}
    function showAdmin(){lockCard.style.display="none";adminCard.style.display="block";render();}

    function unlock(){
      const pin=(pinInput.value||"").trim();
      if(pin===ADMIN_PIN){
        localStorage.setItem(ADMIN_UNLOCK_KEY,"1");
        pinErr.style.display="none";
        showAdmin();
      }else{
        pinErr.style.display="block";
      }
    }

    pinBtn.addEventListener("click",unlock);
    pinInput.addEventListener("keydown",(e)=>{if(e.key==="Enter")unlock();});

    if(localStorage.getItem(ADMIN_UNLOCK_KEY)==="1") showAdmin();
    else showLock();
  </script>
</body>
</html>
