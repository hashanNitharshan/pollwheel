<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Control - Poll Wheel</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f8fafc;padding:18px}
    .card{max-width:1100px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:18px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-size:14px}
    .btn{background:#111827;color:#fff}
    .btn2{background:#e5e7eb}
    .danger{background:#dc2626;color:#fff}
    .ok{background:#16a34a;color:#fff}
    .hr{height:1px;background:#e5e7eb;margin:14px 0}
    input,select{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#f8fafc;font-weight:800}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
    .pill.gray{background:#e5e7eb}
    .pill.green{background:#dcfce7;color:#166534}
    .pill.red{background:#fee2e2;color:#991b1b}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;color:#6b7280;margin-top:4px}
  </style>
</head>
<body>

  <div class="card" id="lockCard" style="display:none;">
    <h1>Admin Login</h1>
    <div class="row">
      <input id="pinInput" type="password" placeholder="Admin PIN" />
      <button class="btn" id="pinBtn">Unlock</button>
    </div>
    <p id="pinErr" style="color:#dc2626;font-weight:800;display:none;margin-top:10px;">Wrong PIN</p>
  </div>

  <div class="card" id="adminCard" style="display:none;">
    <h1>Admin Control Panel</h1>

    <div class="row">
      <button class="btn" id="refreshBtn">Refresh</button>
      <button class="ok" id="assignRandomBtn">Assign RANDOM Winners (No Duplicates)</button>
      <button class="btn2" id="forceLogoutBtn">Force Logout</button>
      <button class="danger" id="resetAllBtn">RESET ALL</button>
    </div>

    <div class="hr"></div>

    <table>
      <thead>
        <tr>
          <th style="width:80px;">Team</th>
          <th style="width:360px;">Admin Mode</th>
          <th>Team Status</th>
          <th style="width:360px;">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const ADMIN_PIN="1234";

    const firebaseConfig = {
      apiKey: "AIzaSyApEQ8ogTpZ94IZRh_GWtCsUhi608x4sG4",
      authDomain: "tpl-poll-wheel.firebaseapp.com",
      projectId: "tpl-poll-wheel",
      storageBucket: "tpl-poll-wheel.firebasestorage.app",
      messagingSenderId: "149256036270",
      appId: "1:149256036270:web:f7d9486571ef69501df23f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const TEAMS=["TS","TPS","TD","TLK","TG","TT"];
    const options=["Selva","Navinkanth","Divagar","Ilayaraja","Janaster","Father of Rakshan"];

    const TEAM_TO_PLAYER={
      TS:"Selva",
      TPS:"Navinkanth",
      TD:"Divagar",
      TLK:"Ilayaraja",
      TG:"Janaster",
      TT:"Father of Rakshan"
    };

    const DEFAULT_MODE="fixed";
    const ADMIN_UNLOCK_KEY="pollwheel_admin_unlocked";

    const lockCard=document.getElementById("lockCard");
    const adminCard=document.getElementById("adminCard");
    const pinInput=document.getElementById("pinInput");
    const pinBtn=document.getElementById("pinBtn");
    const pinErr=document.getElementById("pinErr");

    const tbody=document.getElementById("tbody");
    const refreshBtn=document.getElementById("refreshBtn");
    const forceLogoutBtn=document.getElementById("forceLogoutBtn");
    const resetAllBtn=document.getElementById("resetAllBtn");
    const assignRandomBtn=document.getElementById("assignRandomBtn");

    const pill=(txt,kind)=>`<span class="pill ${kind}">${txt}</span>`;

    function teamRef(team){ return db.collection("teams").doc(team); }

    async function ensureTeamDoc(team){
      const ref=teamRef(team);
      const snap=await ref.get();
      if(!snap.exists){
        await ref.set({
          team,
          loginUsed:false,
          spun:false,
          winner:"",
          mode:"fixed",
          fixedPick: TEAM_TO_PLAYER[team] || "",
          randomPick:"",
          updatedAt: Date.now()
        }, { merge:true });
      }
    }

    async function ensureAll(){
      for(const t of TEAMS) await ensureTeamDoc(t);
    }

    function shuffle(arr){
      const a=arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // Real-time render
    function listenAll(){
      db.collection("teams").onSnapshot((snap)=>{
        const map = {};
        snap.forEach(d=>{ map[d.id]=d.data(); });
        render(map);
      });
    }

    function render(map){
      tbody.innerHTML="";
      TEAMS.forEach(team=>{
        const d = map[team] || {};
        const loginUsed = d.loginUsed === true;
        const spun = d.spun === true;
        const winner = d.winner || "—";
        const mode = d.mode || DEFAULT_MODE;
        const fixedPick = (d.fixedPick && options.includes(d.fixedPick)) ? d.fixedPick : (TEAM_TO_PLAYER[team]||options[0]);
        const randomPick = (d.randomPick && options.includes(d.randomPick)) ? d.randomPick : "—";

        const statusHtml=`
          <div>${loginUsed?pill("LOGIN USED","red"):pill("LOGIN FREE","green")}</div>
          <div style="margin-top:6px;">
            ${spun?pill("SPUN","green"):pill("NOT SPUN","gray")}
            <div class="small">Winner: <b>${winner}</b></div>
          </div>
        `;

        const modeHtml=`
          <div class="row" style="margin:0;">
            <select data-act="setMode" data-team="${team}">
              <option value="fixed" ${mode==="fixed"?"selected":""}>FIXED</option>
              <option value="random" ${mode==="random"?"selected":""}>RANDOM</option>
            </select>
            <select data-act="setFixed" data-team="${team}" ${mode==="random"?"disabled":""}>
              ${options.map(o=>`<option value="${o}" ${o===fixedPick?"selected":""}>${o}</option>`).join("")}
            </select>
          </div>
          <div class="small">Random Pick: <b>${randomPick}</b></div>
        `;

        const actionsHtml=`
          <div class="actions">
            <button class="btn2" data-act="unlockLogin" data-team="${team}">Unlock Login</button>
            <button class="btn2" data-act="resetSpin" data-team="${team}">Reset Spin</button>
            <button class="btn2" data-act="clearRandom" data-team="${team}">Clear Random</button>
            <button class="danger" data-act="wipeTeam" data-team="${team}">Wipe Team</button>
          </div>
        `;

        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><b>${team}</b></td>
          <td>${modeHtml}</td>
          <td>${statusHtml}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function setMode(team, mode){
      await ensureTeamDoc(team);
      const ref=teamRef(team);
      if(mode==="fixed"){
        await ref.set({
          mode:"fixed",
          randomPick:"",
          fixedPick: TEAM_TO_PLAYER[team] || options[0],
          updatedAt: Date.now()
        }, { merge:true });
      }else{
        await ref.set({ mode:"random", updatedAt: Date.now() }, { merge:true });
      }
    }

    async function setFixed(team, pick){
      if(!options.includes(pick)) return;
      await ensureTeamDoc(team);
      await teamRef(team).set({ fixedPick: pick, updatedAt: Date.now() }, { merge:true });
    }

    async function unlockLogin(team){
      await ensureTeamDoc(team);
      await teamRef(team).set({ loginUsed:false, updatedAt: Date.now() }, { merge:true });
    }

    async function resetSpin(team){
      await ensureTeamDoc(team);
      await teamRef(team).set({ spun:false, winner:"", updatedAt: Date.now() }, { merge:true });
    }

    async function clearRandom(team){
      await ensureTeamDoc(team);
      await teamRef(team).set({ randomPick:"", updatedAt: Date.now() }, { merge:true });
    }

    async function wipeTeam(team){
      await ensureTeamDoc(team);
      await teamRef(team).set({
        loginUsed:false,
        spun:false,
        winner:"",
        mode:"fixed",
        fixedPick: TEAM_TO_PLAYER[team] || options[0],
        randomPick:"",
        updatedAt: Date.now()
      }, { merge:true });
    }

    async function resetAll(){
      if(!confirm("RESET ALL?")) return;
      for(const t of TEAMS) await wipeTeam(t);
    }

    async function assignRandomUnique(){
      await ensureAll();

      const snaps = await db.collection("teams").get();
      const map = {};
      snaps.forEach(d=> map[d.id]=d.data());

      const randomTeams = TEAMS.filter(t => (map[t]?.mode || DEFAULT_MODE) === "random");
      const used = new Set();

      // keep already valid random picks
      randomTeams.forEach(t=>{
        const pick = map[t]?.randomPick;
        if(pick && options.includes(pick)) used.add(pick);
      });

      const remaining = options.filter(o=>!used.has(o));
      const pool = shuffle(remaining);

      // if not enough unique, clear all randomPick and reassign fresh
      if(pool.length < randomTeams.filter(t=>!(map[t]?.randomPick && options.includes(map[t]?.randomPick))).length){
        for(const t of randomTeams){
          await teamRef(t).set({ randomPick:"", updatedAt: Date.now() }, { merge:true });
        }
        return assignRandomUnique();
      }

      for(const t of randomTeams){
        const current = map[t]?.randomPick;
        if(current && options.includes(current)) continue;
        const pick = pool.pop();
        await teamRef(t).set({ randomPick: pick, updatedAt: Date.now() }, { merge:true });
      }

      alert("Assigned unique RANDOM winners.");
    }

    refreshBtn.addEventListener("click", async ()=>{ await ensureAll(); });

    forceLogoutBtn.addEventListener("click", ()=>{ alert("Force logout is per-device now. Teams can just close tab."); });

    resetAllBtn.addEventListener("click", resetAll);
    assignRandomBtn.addEventListener("click", assignRandomUnique);

    document.addEventListener("change", async (e)=>{
      const el=e.target;
      const act=el?.dataset?.act;
      const team=el?.dataset?.team;
      if(!act||!team) return;

      if(act==="setMode"){
        const newMode = el.value==="random" ? "random" : "fixed";
        await setMode(team, newMode);
      }
      if(act==="setFixed"){
        await setFixed(team, el.value);
      }
    });

    document.addEventListener("click", async (e)=>{
      const btn=e.target.closest("button");
      if(!btn) return;

      const act=btn.dataset.act;
      const team=btn.dataset.team;

      if(act==="unlockLogin") await unlockLogin(team);
      if(act==="resetSpin") await resetSpin(team);
      if(act==="clearRandom") await clearRandom(team);
      if(act==="wipeTeam"){ if(confirm(`Wipe ${team}?`)) await wipeTeam(team); }
    });

    function showLock(){ lockCard.style.display="block"; adminCard.style.display="none"; }
    function showAdmin(){ lockCard.style.display="none"; adminCard.style.display="block"; }

    function unlock(){
      const pin=(pinInput.value||"").trim();
      if(pin===ADMIN_PIN){
        localStorage.setItem(ADMIN_UNLOCK_KEY,"1");
        pinErr.style.display="none";
        showAdmin();
        ensureAll().then(listenAll);
      }else{
        pinErr.style.display="block";
      }
    }

    pinBtn.addEventListener("click", unlock);
    pinInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") unlock(); });

    if(localStorage.getItem(ADMIN_UNLOCK_KEY)==="1"){
      showAdmin();
      ensureAll().then(listenAll);
    }else{
      showLock();
    }
  </script>
</body>
</html>
